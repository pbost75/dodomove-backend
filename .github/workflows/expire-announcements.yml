name: Expiration automatique des annonces

on:
  # D√âSACTIV√â TEMPORAIREMENT - BUG D√âTECT√â
  # schedule:
  #   - cron: '0 6 * * *'
  # Possibilit√© de d√©clencher manuellement seulement
  workflow_dispatch:

jobs:
  expire-announcements:
    runs-on: ubuntu-latest
    
    steps:
      - name: üöÄ Expirer les annonces DodoPartage
        run: |
          echo "üìÖ D√©but de l'expiration quotidienne des annonces..."
          
          # Appel de l'API d'expiration
          RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" \
            -X POST \
            -H "Content-Type: application/json" \
            -H "User-Agent: GitHub-Actions" \
            -H "X-Source: github-actions" \
            -d '{"source": "github-actions", "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)'"}' \
            https://web-production-7b738.up.railway.app/api/cron/expire-announcements)
          
          # Extraire le code HTTP et le body
          HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
          BODY=$(echo "$RESPONSE" | sed '/HTTP_CODE:/d')
          
          echo "üìä Code de r√©ponse: $HTTP_CODE"
          echo "üìã R√©ponse: $BODY"
          
          # V√©rifier le succ√®s
          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Expiration r√©ussie !"
            
            # Parser les statistiques (optionnel)
            EXPIRED=$(echo "$BODY" | grep -o '"expired":[0-9]*' | cut -d: -f2 | head -1)
            REMAINING=$(echo "$BODY" | grep -o '"remaining_published":[0-9]*' | cut -d: -f2 | head -1)
            
            if [ ! -z "$EXPIRED" ] && [ ! -z "$REMAINING" ]; then
              echo "üìà Statistiques: $EXPIRED annonce(s) expir√©e(s), $REMAINING restante(s)"
            fi
          else
            echo "‚ùå Erreur lors de l'expiration (Code: $HTTP_CODE)"
            echo "üí° R√©ponse: $BODY"
            exit 1
          fi
          
          echo "üéâ Expiration quotidienne termin√©e avec succ√®s !"

      - name: üìä R√©sum√©
        if: always()
        run: |
          echo "::notice title=Expiration DodoPartage::Expiration quotidienne ex√©cut√©e √† $(date -u)" 